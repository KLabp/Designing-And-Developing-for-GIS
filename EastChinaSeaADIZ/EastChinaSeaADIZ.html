<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>East China Sea ADIZ</title>
    <link href="http://localhost/arcgis_js_api/library/3.23/3.23/esri/css/esri.css" rel="stylesheet" type="text/css" />
    <link href="http://localhost/arcgis_js_api/library/3.23/3.23/dijit/themes/tundra/tundra.css" rel="stylesheet" type="text/css" />
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/data.js" type="text/javascript"></script>
    <script type="text/javascript">var dojoConfig = { parseOnLoad: true };</script>
    <script src="http://localhost/arcgis_js_api/library/3.23/3.23/init.js" type="text/javascript"></script>
    <style type="text/css">
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            border: 0;
        }

        #title {
            position: absolute;
            left: 0;
            right: 0;
            top: 5px;
            width: 240px;
            height: 50px;
            text-align: center;
            font-family: LiSu;
            font-weight: bolder;
            font-size: 32px;
            z-index: 20;
            margin: auto;
            transition: color 0.8s;
        }

            #title:hover {
                color: red;
            }

        #homeButton {
            position: absolute;
            top: 95px;
            left: 20px;
            z-index: 10;
        }

        #layers {
            position: absolute;
            width: 228px;
            height: 30px;
            z-index: 10;
            right: 10px;
            bottom: 10px;
            margin: auto;
        }

        .layer {
            width: 70px;
            height: 30px;
            margin-left: 1px;
            margin-right: 1px;
            font-weight: bold;
            font-family: 'Microsoft YaHei';
            font-size: 16px;
            color: black;
            background-color: lightgray;
            outline: none;
            border: 1px solid black;
        }

            .layer:hover {
                background-color: orange;
                font-size: 17px;
            }

        #operators {
            position: absolute;
            width: auto;
            height: auto;
            z-index: 10;
            right: 10px;
            top: 10px;
            margin: auto;
        }

        .operator {
            width: 70px;
            height: 30px;
            display: block;
            font-family: STXihei;
            font-size: 18px;
            color: white;
            background-color: grey;
            outline: none;
            border: 1px solid black;
            margin-top: 2px;
            margin-bottom: 2px;
        }

            .operator:hover {
                font-weight: bold;
                background-color: lightgrey;
                color: black;
            }
    </style>
    <script type="text/javascript">
        dojo.require("esri.tasks.RelationParameters");
        dojo.require("esri.dijit.HomeButton");

        var myMap;
        var areaPolygon;
        var areaLayer;
        var flightLayers = [];
        var pictureSymbols = [];
        var temporarySymbols = [];
        var defendPictureSymbol = null;
        var intervals = [];
        var flight1Points = [];
        var flight2Points = [];
        var indexs = [];
        var multiPoints = [];
        var controlInital = true;
        var controlTurn = true;
        var controlOffset = true;
        var startPoint;
        var endPoint;
        var deltaX;
        var deltaY;
        var pictureWidth;
        var pictureHeight;
        var controlStop = true;

        function Init() {
            var startExent = esri.geometry.Extent({
                "xmin": 102.4956917313,
                "ymin": 19.8934964327,
                "xmax": 141.3036380000,
                "ymax": 36.9910810000,
                "spatialReference": { "wkid": 4326 }
            });
            myMap = new esri.Map("map", {
                basemap: "topo",
                extent: startExent,
                logo: false,
                showAttribution: false
            });

            areaLayer = new esri.layers.GraphicsLayer();
            myMap.addLayer(areaLayer);

            for (var i = 0; i < 3; i++) {
                flightLayers[i] = new esri.layers.GraphicsLayer();
                myMap.addLayer(flightLayers[i]);
            }

            var imagesUrl = [["image/airliner1.png", "image/airliner3.png"],
                ["image/airliner2.png", "image/airliner3.png"],
                ["image/F_fighter1.png", "image/F_fighter2.png"]];
            for (var i = 0; i < imagesUrl.length; i++) {
                var pictureWidth1 = 20;
                var pictureHeight1 = 21;
                if (i == 2) {
                    pictureWidth1 = 20;
                    pictureHeight1 = 15;
                }
                var symbolGroup = [];
                for (var j = 0; j < 2; j++) {
                    var pictureSymbol = new esri.symbol.PictureMarkerSymbol(imagesUrl[i][j], pictureWidth1, pictureHeight1);
                    symbolGroup.push(pictureSymbol);
                }
                pictureSymbols.push(symbolGroup);
            }

            for (var i = 0; i < 3; i++) {
                temporarySymbols[i] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[i][0].toJson());
            }

            defendPictureSymbol = new esri.symbol.PictureMarkerSymbol("image/J_fighter.png", 20, 15);

            relationParams = new esri.tasks.RelationParameters();
            relationParams.relation = esri.tasks.RelationParameters.SPATIAL_REL_INTERSECTION;

            //几何服务
            GeometryServices = new esri.tasks.GeometryService("https://localhost:6443/arcgis/rest/services/Utilities/Geometry/GeometryServer");

            //初始范围按钮
            var homeButton = new esri.dijit.HomeButton({
                map: myMap,
                visible: true
            }, "homeButton");
            homeButton.startup();

            //定义切换底图事件
            dojo.query(".layer").connect("click", function (event) {
                //获得按钮的文本信息
                var value = this.innerHTML;
                switch (value) {
                    case "卫星图":
                        myMap.setBasemap("satellite");
                        break;
                    case "街道图":
                        myMap.setBasemap("streets");
                        break;
                    case "地形图":
                        myMap.setBasemap("topo");
                        break;
                };
            });

            dojo.query(".operator").connect("click", function (event) {
                var value = this.innerText;
                switch (value) {
                    case "运行":
                        if (controlStop) {
                            Cancel();
                            Flight1();
                            Flight2();
                            Flight3();
                        }
                        else {
                            intervals[0] = setInterval("DrawFlight1()", 150);
                            intervals[1] = setInterval("DrawFlight2()", 200);
                            DrawMoveMultiPath();
                        }
                        break;
                    case "停止":
                        Stop();
                        break;
                    case "取消":
                        Cancel();
                        break;
                }
            })

            dojo.connect(myMap, 'onLoad', function (theMap) {
                dojo.connect(myMap, 'resize', MapResize);
                ReadAreaJSONdata();
                LoadArea();
            });
        }

        function MapResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                myMap.resize();
                myMap.reposition();
            }, 500);
        }

        function ReadAreaJSONdata() {
            /*var pointCollection = [];
            //取消ajax方法的异步请求
            $.ajaxSettings.async = false;
            //读取识别区点的JSON文件
            $.getJSON("js/AreaData.json", function (areaData) {
                dojo.forEach(areaData, function (element, index) {
                    var pointCoord = [];
                    pointCoord.push(Number(element.longitude));
                    pointCoord.push(Number(element.latitude));
                    pointCollection.push(pointCoord);
                });
            });
            $.ajaxSettings.async = true;
            return pointCollection;*/

            var pointCollection = [];
            dojo.forEach(AreaData, function (element, index) {
                var pointCoord = [];
                pointCoord.push(Number(element.longitude));
                pointCoord.push(Number(element.latitude));
                pointCollection.push(pointCoord);
            });
            return pointCollection;
        }

        function LoadArea() {
            var pointCollection = ReadAreaJSONdata();

            var areaPolygonSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2),
                new dojo.Color([188, 188, 188, 0.2]));
            //创建识别区
            areaPolygon = new esri.geometry.Polygon(pointCollection);
            var areaGraphic = new esri.Graphic(areaPolygon, areaPolygonSymbol);
            areaLayer.add(areaGraphic);

            //添加识别区名称
            var textSymbol = new esri.symbol.TextSymbol("东海防空识别区");
            textSymbol.setFont(new esri.symbol.Font("16pt", esri.symbol.Font.STYLE_ITALIC,
                esri.symbol.Font.VARIANT_NORMAL, esri.symbol.Font.WEIGHT_BOLD, "Courier"));
            textSymbol.setAngle(300);
            textSymbol.setVerticalAlignment("top");
            var textPoint = new esri.geometry.Point(124.2516830000, 29.1010910000);
            var textGraphic = new esri.Graphic(textPoint, textSymbol);
            areaLayer.add(textGraphic);
        }

        function Flight1() {
            flight1Points = Flight1Data;
            indexs[0] = 0;
            var offsetX = -9.799418929515404;
            var offsetY = -1.9928343242365034;
            var angle = 348.6555492425136;

            for (var i = 0; i < 2; i++) {
                pictureSymbols[0][i].setAngle(angle);
                pictureSymbols[0][i].setOffset(offsetX, offsetY);
            }
            temporarySymbols[0].setAngle(angle);
            temporarySymbols[0].setOffset(offsetX, offsetY);
            intervals[0] = setInterval("DrawFlight1()", 150);
        }

        function DrawFlight1() {
            if (indexs[0] >= flight1Points.length) {
                clearInterval(intervals[0]);
            }
            else {
                flightLayers[0].clear();
            }

            var point = new esri.geometry.Point(flight1Points[indexs[0]].longitude, flight1Points[indexs[0]].latitude);
            relationParams.geometries1 = [point];
            relationParams.geometries2 = [areaPolygon];
            GeometryServices.relation(relationParams, RelationResult1, Error);
            if (indexs[0] + 1 < flight1Points.length) {
                var point1 = new esri.geometry.Point(flight1Points[indexs[0] + 1].longitude, flight1Points[indexs[0] + 1].latitude);
                relationParams.geometries1 = [point1];
                relationParams.geometries2 = [areaPolygon];
                GeometryServices.relation(relationParams, RelationResult1, Error);
            }

            var graphic = new esri.Graphic(point, temporarySymbols[0]);
            flightLayers[0].add(graphic);
            indexs[0]++;
        }

        function RelationResult1(relations) {
            if (relations.length > 0) {
                temporarySymbols[0] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[0][1].toJson());

            }
            else {
                temporarySymbols[0] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[0][0].toJson());
            }
        }

        function Flight2() {
            flight2Points = Flight2Data;
            indexs[1] = 0;
            var offsetX = -9.73695875493631;
            var offsetY = -2.2785157898660966;
            var angle = 347.05427447736093;

            for (var i = 0; i < 2; i++) {
                pictureSymbols[1][i].setAngle(angle);
                pictureSymbols[1][i].setOffset(offsetX, offsetY);
            }
            temporarySymbols[1].setAngle(angle);
            temporarySymbols[1].setOffset(offsetX, offsetY);
            intervals[1] = setInterval("DrawFlight2()", 200);
        }

        function DrawFlight2() {
            if (indexs[1] >= flight2Points.length) {
                clearInterval(intervals[1]);
            }
            else {
                flightLayers[1].clear();
            }

            var point = new esri.geometry.Point(flight2Points[indexs[1]].longitude, flight2Points[indexs[1]].latitude);
            relationParams.geometries1 = [point];
            relationParams.geometries2 = [areaPolygon];
            GeometryServices.relation(relationParams, RelationResult2, Error);
            if (indexs[1] + 1 < flight2Points.length) {
                var point1 = new esri.geometry.Point(flight2Points[indexs[1] + 1].longitude, flight2Points[indexs[1] + 1].latitude);
                relationParams.geometries1 = [point1];
                relationParams.geometries2 = [areaPolygon];
                GeometryServices.relation(relationParams, RelationResult2, Error);
                if (flight2Points[indexs[1] + 1].turn == 1) {
                    var offsetX = 6.639030595168347;
                    var offsetY = -7.478186461731121;
                    var angle = 293.52754478807634;

                    for (var i = 0; i < 2; i++) {
                        pictureSymbols[1][i].setAngle(angle);
                        pictureSymbols[1][i].setOffset(offsetX, offsetY);
                    }
                    temporarySymbols[1].setAngle(angle);
                    temporarySymbols[1].setOffset(offsetX, offsetY);
                }
            }

            var graphic = new esri.Graphic(point, temporarySymbols[1]);
            flightLayers[1].add(graphic);
            indexs[1]++;
        }

        function RelationResult2(relations) {
            if (relations.length > 0) {
                temporarySymbols[1] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[1][1].toJson());

            }
            else {
                temporarySymbols[1] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[1][0].toJson());
            }
        }

        function Flight3() {
            pictureWidth = 20;
            pictureHeight = 15;
            var flight3Path = Flight3Data;
            var pointPath = flight3Path.path;
            var count = pointPath.length;
            for (var i = 0; i < count; i++) {
                var point = new esri.geometry.Point(pointPath[i][0], pointPath[i][1]);
                multiPoints.push(point);
            }
            DrawMoveMultiPath();
        }

        //DDA算法，获取XY方向上的增量
        function GetDeltaXY(start, end) {
            var delta = [];
            var absX = Math.abs(Number(start.x) - Number(end.x));
            var absY = Math.abs(Number(start.y) - Number(end.y));
            var steps; //步长
            if (absX >= absY) {
                steps = absX;
            }
            else {
                steps = absY;
            }
            //X和Y的增量
            var dX = (parseFloat(end.x) - parseFloat(start.x)) / steps;
            var dY = (parseFloat(end.y) - parseFloat(start.y)) / steps;

            delta.push(dX);
            delta.push(dY);
            return delta;
        }

        //移动轨迹
        function DrawMoveMultiPath() {
            if (intervals[2]) {
                clearInterval(intervals[2]);
                flightLayers[2].clear();
            }

            if (controlInital) {
                var slope = (Number(multiPoints[0].y) - Number(multiPoints[1].y)) /
                    (Number(multiPoints[0].x) - Number(multiPoints[1].x));
                if (controlOffset) {
                    var offsetX = -pictureWidth * Math.cos(slope) * Math.sin(slope / Math.abs(slope) * Math.PI / 2) / 2;
                    var offsetY = -pictureWidth * Math.sin(Math.abs(slope)) / 2;
                    pictureSymbols[2][0].setOffset(offsetX, offsetY);
                    pictureSymbols[2][1].setOffset(offsetX, offsetY);
                    temporarySymbols[2].setOffset(offsetX, offsetY);
                }

                var angle = RadToDegree(slope);
                pictureSymbols[2][0].setAngle(angle);
                pictureSymbols[2][1].setAngle(angle);
                temporarySymbols[2].setAngle(angle);

                if (defendPictureSymbol != null) {
                    defendPictureSymbol.setAngle(angle);
                }

                JudgeSpatialRelation(multiPoints[0]);
                if (controlTurn) {
                    flightLayers[2].add(new esri.Graphic(multiPoints[0], temporarySymbols[2]));
                }
                deltaX = GetDeltaXY(multiPoints[0], multiPoints[1])[0] / 10;
                deltaY = GetDeltaXY(multiPoints[0], multiPoints[1])[1] / 10;
                controlTurn = true;
                controlInital = false;
            }

            var point = new esri.geometry.Point(multiPoints[0].x + deltaX, multiPoints[0].y + deltaY);
            JudgeSpatialRelation(point);
            //保证符号显示的一致性
            var point2 = new esri.geometry.Point(multiPoints[0].x + 2 * deltaX, multiPoints[0].y + 2 * deltaY);
            JudgeSpatialRelation(point2);
            flightLayers[2].add(new esri.Graphic(point, temporarySymbols[2]));

            if (temporarySymbols[2].url == pictureSymbols[2][1].url) {
                if (defendPictureSymbol != null) {
                    var point3 = new esri.geometry.Point(point.x - 4 * Math.abs(deltaX), point.y - 2 * Math.abs(deltaY));
                    flightLayers[2].add(new esri.Graphic(point3, defendPictureSymbol));
                }
            }

            multiPoints[0] = new esri.geometry.Point(point.x, point.y);

            if ((Math.abs(point.x - multiPoints[1].x) <= Math.abs(deltaX / 2.0) && Math.abs(point.y - multiPoints[1].y) < Math.abs(deltaY)) ||
                (Math.abs(point.x - multiPoints[1].x) < Math.abs(deltaX) && Math.abs(point.y - multiPoints[1].y) <= Math.abs(deltaY / 2.0))) {
                if (multiPoints.length == 2) {
                    clearInterval(intervals[2]);
                }
                else if (multiPoints.length > 2) {
                    multiPoints.shift();
                    intervals[2] = setInterval("DrawMoveMultiPath()", 200);
                    controlTurn = false;
                    controlInital = true;
                }
                else {
                    return;
                }
            }
            else {
                intervals[2] = setInterval("DrawMoveMultiPath()", 200);
            }
        }

        function JudgeSpatialRelation(geometry) {
            relationParams.geometries1 = [geometry];
            relationParams.geometries2 = [areaPolygon];
            GeometryServices.relation(relationParams, RelationResult3, Error);
        }

        function RelationResult3(relations) {
            if (relations.length > 0) {
                temporarySymbols[2] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[2][1].toJson());
                controlOffset = false;
            }
            else {
                temporarySymbols[2] = new esri.symbol.PictureMarkerSymbol(pictureSymbols[2][0].toJson());
            }
        }

        function RadToDegree(r_param) {
            var degree = 180.0 / Math.PI * Math.atan(r_param);
            if (degree >= 0) {
                return 360 - degree;
            }
            else {
                return 180 - degree;
            }
        }

        function Error(error) {
            console.log(error);
        }

        function Stop() {
            for (var i = 0; i < 3; i++) {
                if (intervals[i]) {
                    clearInterval(intervals[i]);
                }
            }
            controlStop = false;
        }

        function Cancel() {
            Stop();

            intervals = [];
            flight1Points = [];
            flight2Points = [];
            indexs = [];
            multiPoints = [];
            controlInital = true;
            controlTurn = true;
            controlOffset = true;
            startPoint = null;
            endPoint = null;
            deltaX = null;
            deltaY = null;
            pictureWidth = null;
            pictureHeight = null;
            controlStop = true;

            for (var i = 0; i < 3; i++) {
                if (flightLayers[i].graphics != null) {
                    flightLayers[i].clear();
                }
            }
        }

        dojo.addOnLoad(Init);

    </script>
</head>
<body class="tundra">
    <div id="title">东海防空识别区</div>
    <div id="map"></div>
    <div id="layers">
        <button id="satellite" class="layer">卫星图</button>
        <button id="streets" class="layer">街道图</button>
        <button id="topo" class="layer">地形图</button>
    </div>
    <div id="operators">
        <button id="run" class="operator">运行</button>
        <button id="stop" class="operator">停止</button>
        <button id="cancel" class="operator">取消</button>
    </div>
    <div id="homeButton"></div>
</body>
</html>